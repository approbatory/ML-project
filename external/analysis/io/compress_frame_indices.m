function compressed_indices = compress_frame_indices(orig_indices, trim)
% Recomputes the frame indices to be used with the concatenated Miniscope
%   recording (e.g. generated by 'concatenate_bigtiff'). Note that the
%   concatenation and 'compress_frame_indices' must be invoked with the
%   same 'trim' parameters!
%
% Inputs:
%   orig_indices: [num_trials x 4] matrix of frame indices as generated
%       by the plus maze output (as of Cohort 9). Each row represents
%       [trial-start gate-open gate-close trial-end].
%   trim: Number of frames to chop off from the beginning and end of each
%       trial (i.e. to omit dark frames at the beginning of trials).
%
% Example usage:
%   orig_indices = get_trial_frame_indices('mouse7_day21_ego-left.txt');
%   comp_indices = compress_frame_indices(orig_indices, [10 5]);

num_trials = size(orig_indices, 1);

offsets = diff(orig_indices,1,2);
offsets(:,1) = offsets(:,1) - trim(1);
offsets(:,3) = offsets(:,3) - trim(2);

compressed_indices = zeros(size(orig_indices));

% Trial 1
compressed_indices(1,1) = 1;
compressed_indices(1,2:end) = compressed_indices(1,1) + ...
                              cumsum(offsets(1,:));

for trial_idx = 2:num_trials
    compressed_indices(trial_idx,1) = ...
        compressed_indices(trial_idx-1,end) + 1;
    compressed_indices(trial_idx,2:end) = ...
        compressed_indices(trial_idx,1) + ...
        cumsum(offsets(trial_idx,:));
end